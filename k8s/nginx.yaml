apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
data:
  nginx.conf: |
    user nginx;
    worker_processes auto;
    events {
        worker_connections 1024;
    }
    http {
        # 1. 필수: 파일 형식(MIME) 정의 포함
        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        server {
            listen 80;
            
            # 프론트엔드 정적 파일 설정
            location / {
                root /var/www/frontend;
                index index.html;
                # 2. SPA 사용 시 필수: 새로고침 시 404 방지
                try_files $uri $uri/ /index.html;
            }

            # 백엔드 API 프록시 설정
            location /api/ {
                # 3. 타임아웃 및 헤더 설정 추가 (안정성)
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host $host;
                proxy_cache_bypass $http_upgrade;
                
                proxy_pass http://gateway:5000; 
            }
        }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
spec:
  replicas: 1 # 명시적으로 복제본 수 지정
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: jaewoozzang/frontend:v0.8
        ports:
        - containerPort: 80
        volumeMounts:
        - name: config
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
      volumes:
      - name: config
        configMap:
          name: nginx-config
---
apiVersion: v1
kind: Service
metadata:
  name: nginx
spec:
  type: NodePort
  ports:
    - port: 80
      targetPort: 80
      nodePort: 30080
  selector:
    app: nginx