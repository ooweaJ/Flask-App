version: '3.8'

services:
  # Nginx: 프론트엔드 제공 및 리버스 프록시
  nginx:
    image: nginx:latest
    ports:
      - "8080:80" # 호스트의 8080 포트를 컨테이너의 80 포트와 연결
    volumes:
      - ./frontend:/var/www/frontend:ro # 프론트엔드 파일을 컨테이너에 마운트 (읽기 전용)
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro # Nginx 설정을 컨테이너에 마운트 (읽기 전용)
    depends_on:
      - gateway
    networks:
      - app-network

  # API 게이트웨이
  gateway:
    build: ./gateway
    ports:
      - "5000:5000"
    networks:
      - app-network
    depends_on:
      - auth_server
      - employee_server
      - photo_service

  # 인증 서버
  auth_server:
    build: ./auth_server
    ports:
      - "5001:5001"
    networks:
      - app-network

  # 직원 정보 서버
  employee_server:
    build: ./employee_server
    ports:
      - "5002:5002"
    networks:
      - app-network
    depends_on:
      - photo_service
      # 참고: 실제 프로덕션에서는 DB가 준비될 때까지 기다리는 로직이 필요합니다.
      - db
  
  # 사진 처리 서비스
  photo_service:
    build: ./photo_service
    ports:
      - "5003:5003"
    volumes:
      - ./photo_service/data:/app/data # 사진 데이터를 호스트와 공유
    networks:
      - app-network

  # 참고: MySQL 데이터베이스 서비스
  db:
     image: mysql:8.0
     environment:
       MYSQL_ROOT_PASSWORD: kosa1004
       MYSQL_DATABASE: employees
     ports:
       - "3306:3306"
     volumes:
       - ./employee_server/database_create_tables.sql:/docker-entrypoint-initdb.d/init.sql
     networks:
       - app-network

networks:
  app-network:
    driver: bridge
